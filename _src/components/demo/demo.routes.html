<Route ref:router bind:pathname bind:path>
    {{#if innerComponent}}
    <:Component {innerComponent} />
    {{/if}}
</Route>

<script>
    import Route from 'svelte-routing/Route.html';
    import store from './demo.store.js';
    import capitalize from '@/components/tools/title-case';
    import findExport from '../tools/find-export.js';
    import requireUniversal from 'require-universal-module';
    import { createMemoryHistory, createBrowserHistory } from 'svelte-routing';
    import path from 'path';

    /* globals __APP_ROUTES__ */
    const appRoutes = __APP_ROUTES__ || {};

    function asyncRequire(pathname) {
        return requireUniversal(() => import(
            /* "webpackChunkName": "demo-routes/[request]", "webpackMode": "lazy" */
            '@/components/' + pathname + '/' + pathname + '.demo.html'
        ), {
            resolve: require.resolveWeak('@/components/' + pathname + '/' + pathname + '.demo.html'),
            chunkName: "demo-routes/[request]",
            path: '@/components/' + pathname + '/' + pathname + '.demo.html',
            onLoad: module => console.log('LOADED\n', module)
        });
    }


    if (!window) {
        createMemoryHistory();
        const tools = asyncRequire(appRoutes.componentPath);
        const { requireSync, requireAsync, addModule, mod } = tools;

        const component = require.resolveWeak('@/components/' + appRoutes.componentPath + '/' + appRoutes.componentPath + '.demo.html');

        debugger;
        console.log(component);

        __dirname = path.resolve(process.cwd(), 'dist');
        console.log(__dirname);
        appRoutes.innerComponent = __webpack_require__(component.replace('.demo.html', ''));

        //console.log('MOD?', mod);
        // requireAsync().then((comp) => {
        //     appRoutes.innerComponent = comp;
        // });
        console.log('COMPONENT', appRoutes.innerComponent);
    }
    else { createBrowserHistory(); }

    export default {
        components: {Route},
        data: () => (Object.assign({},
            {
                pageTitle: null,
                routeUrl: null,
                currentRoute: '',
                path: '/components/:demo',
                innerComponent: appRoutes
            }, appRoutes)
        ),
        oncreate() {
            // console.log('Demo Router Creation:', this);
            this.set({'initialRoute': this.get('pathname')});

            this.refs.router.observe('match', (match) => {
                console.log('changed', this);
                const initial = this.get('initialRoute');
                const current = match && match.pathname;

                if (current !== initial && initial && match) {
                    asyncRequire(
                        match.params.demo
                    ).then((component) => {
                        this.set({'innerComponent': findExport(component)});
                        store.set({'pageTitle': capitalize(match.params.demo)});
                    });
                }
            });
        },
        setup(DemoRouter) {},
        store: () => store
    };


</script>
