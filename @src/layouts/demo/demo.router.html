<!-- Used for /path/to/thing/index.html or /path/to/thing/ -->
<Route path='/:path([^.]*)*/:file([^.]+\.html)?'
    {...history} {pathname}
    bind:match="match"
>
{#if innerComponent}
    <svelte:component this={innerComponent} />
{:else}
    <Errors message="{errors.message}" stack="{errors.stack}"></Errors>
{/if}
</Route>

<script>
import Route from 'svelte-routing/Route.html?ssr';
import capitalize from '@/helpers/title-case';
import findExport from '@/helpers/find-export.js';
import checkRoute from './check-route.js';
import Errors from '@/pages/_error.svelte';
import { getHistory } from 'svelte-routing';

let errors = '';

export default {
    components: { Route, Errors },
    data() {
        const history = getHistory();
        //console.log(history.location);
        return {
            error: '',
            pathname: history.location.pathname,
            history,
        }
    },
    helpers: {
        errors,
    },
    computed: {
        props: (state) => state,
        innerComponent: ({ match, pathname }) => {
            const page = checkRoute(pathname);
            //console.log('page:', page, match);
            console.log('GLOB PAGES:',
                require('fast-glob').sync( process.cwd() +
        '/@src/pages/[!_]**/[!_]*.(html|svelte)')
            )
            if (!page) {
                errors = new Error(`No page found at <strong>${pathname}</strong>`);
                return false;
            }
            try {
                const component = findExport(
                    require('@/pages/' + page + '.html')
                );

                return component;
            } catch(e) {
                console.log(e);
                errors = new Error(e);
                return false;
            }
        }
    },
};
</script>
