<Route ref:router bind:pathname bind:path>
    <svelte:component this={innerComponent} />
</Route>

<script>
import store from './demo.store.js';
import capitalize from '@/helpers/title-case';
import findExport from '@/helpers/find-export.js';
import Route from 'svelte-routing/Route.html';
import findPage from './check-route.js';
const pages = require(`val-loader?{"returnPages": true}!./create-nav.js`);

// Find the initial state of the page, provided by the template
const appState = typeof window === 'undefined' ? {} : window.__APP_STATE__;
// const globalState = findGlobalState();

export default {
    components: { Route },
    data: () => ({
        path: '/:page*',
        demoTitle: 'Demo',
        currentRoute: '',
    }),
    oncreate() {
        const router = this.refs.router;

        // store.set({ pageTitle: capitalize(appState.componentPath) });
        store.set({ currentRoute: router.get()['pathname'] });

        router.on('state', ({ changed, current }) => {
            if (changed.pathname) {
                store.set({ currentRoute: current.pathname });
            }
        });

        router.on('update', ({ changed, current }) => {
            if (changed.match) {
                const match = current.match;

                getPage(match.params.page).then((comp) => {
                    this.set({ innerComponent: findExport(comp) });
                    store.set({ pageTitle: capitalize(match.params.page) });
                    store.set({ currentRoute: match.params.page });
                });
            }
        });
    },
    setup(DemoRouter) {
        DemoRouter.getComponent = async (componentPath) => {
            console.log(componentPath);
            const comp = await getPage(componentPath);
            return findExport(comp);
        };
    },
    store: () => store,
};

async function getPage(pathname) {
    let component;
    const page = findPage(pathname);

    if (!page) {
        console.log('No page found at ' + pathname);
        return false;
    }

    try {

        component = await import(/* webpackChunkName: "page-[request]" */
            /* webpackMode: "lazy" */
            /* webpackPrefetch: true */
            /* webpackPreload: -1 */
            '@/pages/' + page  + '.html');

        return component;
    } catch(e) {
        console.error(e);
        return false;
    }
    // try {

    // }
    // catch(e) {
    //     console.log(e);
    //     try {
    //         component = await import(/* webpackChunkName: "route-[request]" */
    //         /* webpackMode: "lazy" */
    //         /* webpackPrefetch: true */
    //         /* webpackPreload: -1 */
    //         '@/pages/' + pathname + '/' + pathname + '.html');
    //     } catch(e) {
    //         console.log(e);
    //         component = false;
    //     }
    // }
    // return component;
}

async function findGlobalState() {
    appState.innerComponent = await findExport(
        getComponent(appState.componentPath)
    );
    return appState;
}
</script>
