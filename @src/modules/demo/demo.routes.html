<Route hydrate="{true}" ref:router bind:pathname bind:path>
    <svelte:component this={innerComponent} />
</Route>

<script>
import store from './demo.store.js';
import capitalize from '@/helpers/title-case';
import findExport from '@/helpers/find-export.js';
import { createBrowserHistory } from 'svelte-routing';

// Find the initial state of the page, provided by the template
const appState = window.__APP_STATE__;

export default {
    components: {
        Route: 'svelte-routing/Route.html',
    },
    data() {
        const globalState = findGlobalState();
        return Object.assign(
            {},
            {
                path: '/:demo',
                demoTitle: 'Demo',
                currentRoute: '',
            },
            globalState
        );
    },
    oncreate() {
        const router = this.refs.router;

        store.set({ pageTitle: capitalize(appState.componentPath) });
        store.set({ currentRoute: router.get()['pathname'] });

        router.on('state', ({ changed, current }) => {
            if (changed.pathname) {
                store.set({ currentRoute: current.pathname });
            }
        });

        router.on('update', ({ changed, current }) => {
            if (changed.match) {
                const match = current.match;

                getComponent(match.params.demo).then((comp) => {
                    this.set({ innerComponent: findExport(comp) });
                    store.set({ pageTitle: capitalize(match.params.demo) });
                    store.set({ currentRoute: match.params.demo });
                });
            }
        });
    },
    setup(DemoRouter) {
        DemoRouter.getComponent = async (componentPath) => {
            const comp = await getComponent(componentPath);
            return findExport(comp);
        };
    },
    store: () => store,
};

function getComponent(pathname) {
    return import(/* webpackChunkName: "demo-route" */
    /* webpackMode: "lazy" */
    /* webpackPrefetch: true */
    /* webpackPreload: -1 */
    '@/components/' + pathname + '/' + pathname + '.demo.html');
}

async function findGlobalState() {
    appState.history = createBrowserHistory();
    appState.innerComponent = await findExport(
        getComponent(appState.componentPath)
    );
    return appState;
}
</script>
